{% extends "base_admin.html" %}

{% block title %}Bảng Thanh Toán Lương{% endblock %}

{% block content %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="container mt-4">
    <h2 class="text-center mb-4">Bảng Thanh Toán Lương</h2>

     {% if selected_month %}
        <p class="text-center fw-bold">Tháng đang xem: {{ selected_month }}</p>
    {% endif %}
    <!-- Dropdown chọn tháng -->
    <form method="get">
        <label for="month">Chọn tháng:</label>
        <input type="month" id="month" name="month"
               value="{{ selected_month|default:'' }}">
        <button type="submit" class="btn btn-primary">Lọc</button>

        <div>
        <label for="status" class="form-label">Trạng thái:</label>
        <select id="status" name="status" class="form-select">
            <option value="">Tất cả</option>
            <option value="paid" {% if selected_status == 'paid' %}selected{% endif %}>Đã thanh toán</option>
            <option value="unpaid" {% if selected_status == 'unpaid' %}selected{% endif %}>Chưa thanh toán</option>
        </select>
         </div>
    </form>

    <!-- Bảng lương -->
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>STT</th>
                <th>Họ tên</th>
                <th>Chức vụ</th>
                <th>Lương cơ bản</th>
                <th>Hệ số lương</th>
                <th>Tổng lương</th>
            </tr>
        </thead>
        <tbody>
            {% for s in salaries %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ s.username }}</td>
                <td>{{ s.rank }}</td>
                <td>{{ s.amount }}</td>
                <td>{{ s.multiplier }}</td>
                <td>{{ s.total_salary|floatformat:1 }}</td>
                <td>
    <!-- Nút mở modal cho cả đã và chưa thanh toán -->
                <button type="button" class="btn {% if s.is_paid %}btn-info{% else %}btn-outline-dark{% endif %} btn-sm"
                        data-bs-toggle="modal" data-bs-target="#paymentModal{{ forloop.counter }}">
                    {% if s.is_paid %}Đã thanh toán{% else %}Thanh toán{% endif %}
                </button>

                <!-- Modal -->
                <div class="modal fade" id="paymentModal{{ forloop.counter }}" tabindex="-1" aria-labelledby="modalLabel{{ forloop.counter }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel{{ forloop.counter }}">
                            Chi tiết thanh toán
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>

                      <div class="modal-body">
                        <p><strong>Nhân viên:</strong> {{ s.username }}</p>
                        <p><strong>Chức vụ:</strong> {{ s.rank }}</p>
                        <p><strong>Hệ số lương:</strong> {{ s.multiplier }}</p>
                        <p><strong>Thành tiền:</strong> {{ s.total_salary|floatformat:1 }}</p>
                        {% if s.is_paid %}
                            <p><strong>Thành tiền:</strong> {{ s.total_salary|floatformat:1 }}</p>
                            <p><strong>Ngày thanh toán:</strong> {{ s.payment_date|date:"d/m/Y" }}</p>
                            <p><strong>Người duyệt:</strong> {{ admin_id }}</p>
                        {% endif %}
                      </div>

                      <div class="modal-footer">
                        {% if not s.is_paid %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="staff_id" value="{{ s.id }}">
                            <input type="hidden" name="salary_id" value="{{ s.salary_id }}">
                            <input type="hidden" name="total_amount" value="{{ s.total_salary }}">
                            <input type="hidden" name="month" value="{{ selected_month }}">
                            <button type="submit" class="btn btn-primary">Thanh toán</button>
                        </form>
                        {% endif %}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                      </div>

                    </div>
                  </div>
                </div>
            </td>

            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center text-muted">Không có dữ liệu lương</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}